---
title: "Ceph Code Walkthroughs: OSD Read Lease"
date: 2021-12-02
updated: 2021-12-03
tags:
categories:
- "视频总结"
subtitle: tech
---


### 会议纪要

#### 会议主题：Ceph分布式存储系统中的读写一致性问题及解决方案

#### 会议时间：[具体时间]

#### 参会人员：[参会人员名单]

#### 会议内容总结：

1. **问题背景**：
   - 在Ceph中，使用RADOS时，写操作需要触及所有副本，确保所有副本一致。
   - 读操作通常只从主副本（Primary）读取，但存在网络分区可能导致主副本未意识到集群状态变化，继续服务旧数据读取请求。

2. **历史问题**：
   - 该问题已存在较长时间，最终在Octopus版本中得到修复。
   - 修复方法涉及引入“租约”（leases）机制，通过租约间隔属性确保读写一致性。

3. **解决方案详述**：
   - **租约机制**：通过租约消息在主副本和副本之间同步状态，确保读操作的一致性。
   - **时间戳处理**：使用单调时钟（monotonic clock）处理时间戳，避免时钟偏差问题。
   - **租约间隔设置**：租约间隔可通过全局配置选项lease_ratio设置，乘以心跳间隔（heartbeat_grace）来确定。

4. **新引入的PG状态**：
   - **Laggy状态**：当PG活跃但租约未及时更新时，PG进入Laggy状态，暂停读取请求，直到租约更新。
   - **Wait状态**：当PG正在进行 peering 且前一个间隔的上限仍在未来时，PG进入Wait状态，暂停写操作，直到前一个间隔的租约过期。

5. **优化措施**：
   - **快速关闭通知**：OSD可以通过发送“标记我为死亡”消息给Monitor，或者通过连接拒绝回调机制快速标记OSD为死亡，从而加速租约过期处理。
   - **历史记录处理**：在 peering 过程中，通过历史记录（pg_history）处理前一个间隔的租约状态，确保不会因为过早清除租约信息导致读写不一致。

6. **测试与验证**：
   - 通过单元测试和功能测试验证了修复方案的有效性，确保在各种网络分区情况下读取操作的一致性。

#### 决定事项：
- 确认Octopus版本中引入的租约机制和相关优化措施有效解决了读写一致性问题。
- 需要进一步完善快速关闭通知机制，确保OSD能够及时发送死亡消息给Monitor。

#### 后续行动计划：
- 继续监控集群状态，确保租约机制稳定运行。
- 完善文档，详细记录租约机制的配置和使用方法。
- 定期进行性能测试，确保引入的机制不会对系统性能产生负面影响。

#### 会议结束语：
感谢所有参会人员的积极参与和讨论，本次会议对于理解Ceph中的读写一致性问题及其解决方案具有重要意义。期待后续的实施和验证工作能够顺利进行。

---

**备注**：本次会议纪要涵盖了会议的关键细节、讨论的主要议题、决定的事项以及后续的行动计划，确保了会议内容的全面性和准确性。