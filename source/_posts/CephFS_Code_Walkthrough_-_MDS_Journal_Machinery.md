---
title: "CephFS Code Walkthrough: MDS Journal Machinery"
date: 2021-10-07
updated: 2021-10-08
tags:
categories:
- "视频总结"
subtitle: tech
---


### 会议纪要

#### 会议主题：Ceph MDS 日志结构与优化讨论

#### 会议时间：[具体时间]

#### 参会人员：[参会人员名单]

#### 会议内容总结：

1. **MDS 日志概述**：
   - MDS 日志（Metadata Journal）是 MDS（Metadata Server）的主要元数据变更持有者。
   - 任何需要持久化的元数据变更都会记录在 MDS 日志中。
   - 日志包含近期元数据变更、客户端会话信息、导出导入状态、清除状态同步等。

2. **客户端会话信息**：
   - 新客户端连接时，MDS 会记录会话信息到日志中，这对故障恢复特别重要。
   - MDS 需要知道所有连接的客户端，以确保客户端重新获取其 caps 并重新建立状态。

3. **日志结构与管理**：
   - MDS 日志在逻辑上是一个循环缓冲区，但在物理上只占用有限的对象集。
   - 日志对象的大小通常为 4MB，当一个日志对象满后，MDS 会移动到下一个日志对象。

4. **日志指针**：
   - 日志指针是一个双指针结构，用于指示当前 MDS 日志的位置。
   - 日志指针的存在是为了便于进行灾难恢复或日志重置。

5. **日志头部信息**：
   - 日志头部包含写入位置、过期位置和修剪位置等信息，这些信息用于管理日志对象的生命周期。

6. **日志事件类型**：
   - 日志事件包括子树映射、新会话信息、caps 更新等。
   - 子树映射事件在每个新日志段开始时写入，以简化数据恢复。

7. **日志优化**：
   - 近期优化包括将打开文件表移出 MDS 日志，以减少日志大小和提高 MDS 故障转移时间。
   - 未来可能的优化包括将递归 unlink RPC 移出日志，以及重新考虑客户端会话的日志记录方式。

8. **代码实现讨论**：
   - 讨论了 `osdc` 库中的日志管理代码，包括日志指针对象、日志头部对象和日志事件的处理。
   - 强调了日志恢复和重放的逻辑，以及如何处理日志事件的持久化。

#### 决定事项：
- 需要进一步审查和可能合并 Jung 的 PR，该 PR 旨在将子树映射移出 MDS 日志，以解决性能和可扩展性问题。

#### 后续行动计划：
- 继续审查和测试 Jung 的 PR，确保其对 MDS 性能的提升。
- 考虑未来对 MDS 日志的其他潜在优化，如客户端会话管理和递归 unlink RPC 的处理。

#### 会议结束：
- 会议在讨论了所有议题后结束，感谢所有参与者的参与，并约定下次会议时间。

---

以上是本次会议的详细纪要，涵盖了会议的关键细节、讨论的主要议题、决定的事项以及后续的行动计划。