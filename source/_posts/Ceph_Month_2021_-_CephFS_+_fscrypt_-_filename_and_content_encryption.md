---
title: "Ceph Month 2021: CephFS + fscrypt: filename and content encryption"
date: 2021-06-24
updated: 2021-06-25
tags:
categories:
- "视频总结"
subtitle: tech
---


### 会议纪要

#### 会议主题：Ceph分布式存储系统中的透明加密支持

#### 主讲人：Jeff

#### 会议时间：[具体时间]

#### 会议地点：[具体地点]

#### 参会人员：[参会人员名单]

#### 会议内容总结：

1. **项目背景与目标**：
   - Jeff自一年前开始着手一个项目，旨在为Ceph文件系统提供透明加密支持。
   - 该项目涉及的核心组件是`fscrypt`，一个内核库，文件系统可以调用它来实现文件名、文件内容和符号链接目标的透明加密。

2. **技术细节**：
   - `fscrypt`在文件系统级别操作，不需要密钥来挂载文件系统，但需要密钥来访问和操作加密的目录树。
   - 目前支持`fscrypt`的文件系统包括ext4、f2fs和ubifs，Jeff正在努力使其适用于网络文件系统。

3. **加密机制**：
   - 每个加密的目录树有一个主密钥，每个加密的inode有一个关联的加密上下文。
   - `fscrypt`使用密钥派生函数生成每个inode的密钥，确保即使丢失密钥也能清理目录并回收空间。

4. **用户工具与工作流程**：
   - 提供了一个用Golang编写的用户空间工具，用于生成和管理主密钥。
   - 工作流程包括初始化、文件系统设置、加密空目录以及锁定和解锁目录。

5. **inode数据存储**：
   - 每个inode关联一个40字节的blob，包含加密模式、主密钥ID和随机数据（nonce）等信息。
   - 为了确保文件名的合法性，使用base64编码，并在必要时对文件名进行截断和哈希处理。

6. **MDS（元数据服务器）支持**：
   - 引入了一个新的fs crypt auth属性，挂载在inode上，MDS将其视为不透明的blob。
   - 增加了新的pert entry alternate name字段，用于存储完整的加密文件名。

7. **内容加密挑战**：
   - 内容加密仍在进行中，涉及AES加密和处理块数据的问题。
   - 需要处理截断操作，确保不会破坏加密块的完整性。

8. **演示与反馈**：
   - Jeff展示了如何在Ceph集群中使用`fscrypt`加密目录，并演示了加密前后的文件名变化。
   - 讨论了将此功能扩展到其他文件系统（如SMB和NFS）的可能性。

9. **后续行动计划**：
   - 继续完善内容加密部分，解决截断操作和数据路径的问题。
   - 探索将加密功能集成到新的库模块netfs中，以支持更广泛的网络文件系统。

#### 决定事项：
- 继续推进`fscrypt`在Ceph中的集成，特别是内容加密和数据路径的优化。
- 考虑将此功能扩展到其他文件系统，如SMB和NFS。

#### 后续行动：
- Jeff将继续完善`fscrypt`的实现，并寻求社区的帮助和支持。
- 社区成员可以关注并参与相关的代码审查和测试工作。

#### 会议结束语：
- Jeff感谢大家的参与和反馈，并期待在未来的版本中看到这一功能的完整实现。

---

**注：** 以上纪要涵盖了会议的关键细节、讨论的主要议题、决定的事项以及后续的行动计划，保留了部分计算机科学/Ceph相关领域英文原文的关键词。