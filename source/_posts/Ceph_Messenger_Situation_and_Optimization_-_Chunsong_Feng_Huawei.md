---
title: "Ceph Messenger Situation and Optimization - Chunsong Feng, Huawei"
date: 2023-05-05
updated: 2023-05-05
tags:
categories:
- "视频总结"
subtitle: tech
---


### 会议纪要

#### 会议主题：软件自消息传递情况与优化

#### 会议议程：
1. **当前RDMA消息模块的不足**
2. **在自消息模块中启用UCX（Unified Communication X）的措施**
3. **性能测试结果**

#### 讨论内容：

1. **当前RDMA消息模块的问题**
   - **流量控制缺失**：导致性能波动，特别是在大包读写测试中。
   - **数据复制问题**：在发送和接收路径中存在数据复制。
   - **使用限制**：客户端和服务器需要使用RDMA连接，但客户端通常没有RDMA设备，只能使用DSP。
   - **日志设计**：后续解释。
   - **固定长度消息**：使用固定长度发送和接收消息，影响效率。

2. **UCX架构与关键设计**
   - **UCX堆栈**：在自消息模块中引入UCX堆栈，使用UCX连接客户端和服务器。
   - **中断与轮询模型**：处理设备事件。
   - **不同大小的消息处理**：使用不同的协议处理小包和大包。
   - **UCX API**：选择实际消息API实现零拷贝接收。

3. **自RDMA与UCX堆栈的运行模块**
   - **RDMA堆栈**：使用RDMA轮询线程和匹配工作者，共享QPL连接。
   - **UCX堆栈优化**：优化锁和会话调用，使用连接映射，消除日志需求。

4. **零拷贝接收**
   - **实现两个映射**：分别处理小包和大包。
   - **预分配内存**：提高接收效率。

5. **性能测试**
   - **基准测试**：使用100 Gigabit技术，4KB包，Q深度为32，UCX堆栈表现出更好的性能和效率。
   - **类性能测试**：使用RBDs进行测试，实现了约20%的性能提升。

#### 未来计划：
- **性能调优**：尝试更多协议和发送接收协议。

#### 提问与回答：
- **性能提升**：与TCP相比，性能提升约10%。
- **延迟问题**：尚未进行延迟测试，但UCX可能提供更低的延迟。
- **RDMA代码问题**：RDMA代码集成问题，需要移除中间层以充分利用RDMA。

#### 决定事项：
- **提出拉取请求**：计划在三周内创建拉取请求，将UCX消息传递整合到主分支。

#### 后续行动计划：
- **创建拉取请求**：整合UCX消息传递。
- **延迟测试**：进行延迟测试，特别是尾延迟，以展示UCX的优势。

#### 会议结束：
- **感谢与结束语**：感谢所有参与者的贡献和讨论，会议圆满结束。

[会议纪要结束]