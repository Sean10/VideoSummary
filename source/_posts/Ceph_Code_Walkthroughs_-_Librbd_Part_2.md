---
title: "Ceph Code Walkthroughs: Librbd Part 2"
date: 2021-03-10
updated: 2021-03-10
tags:
categories:
- "视频总结"
subtitle: tech
---


### 会议纪要

#### 会议概述
会议日期：2月23日  
会议主题：Ceph RBD（Live RBD）代码走读第二部分  
主讲人：Jason  
参会人员：Ceph社区成员

#### 主要议题
1. **RBD I/O路径概述**
   - **I/O请求处理流程**：从API层开始，经过多个可插拔层（如QoS、独占锁、刷新状态机等），最终到达核心层处理对象请求。
   - **librbd.cc文件**：作为C和C++ API的入口点，负责将I/O请求重定向到librbd内部更深层次的处理。

2. **I/O请求详细流程**
   - **API层**：在`api/io.cc`文件中，读写方法通过图像分发规范（Image Dispatch Spec）描述I/O请求。
   - **分发层**：I/O请求通过多个分发层，每个层可以对I/O进行不同的处理（如排队、QoS控制、独占锁检查等）。
   - **核心层**：将图像范围（Image Extent）转换为对象范围（Object Extent），因为RBD设备由多个对象组成。

3. **对象请求状态机**
   - **读请求**：从OSD读取数据，如果对象不存在，则从父图像读取数据。
   - **写请求**：包括写、丢弃、写相同、比较写等操作，涉及对象映射（Object Map）的预更新和后更新。
   - **复制上状态机**：从父图像复制数据到子图像，支持实时迁移（Live Migration）。

4. **可插拔层（Pluggable Layers）**
   - **分发层的作用**：每个层可以对I/O请求进行不同的处理，如QoS控制、独占锁检查等。
   - **分发层的实现**：通过模板化的分发器（Dispatcher）和访问者模式（Visitor Pattern）实现。

5. **总结与展望**
   - **I/O路径的复杂性**：通过状态机和分发层处理I/O请求，确保数据的一致性和性能。
   - **未来工作**：继续优化和扩展librbd的功能，如加密层（Crypto Layer）和实时迁移（Live Migration）。

#### 决定事项
- 继续优化librbd的I/O路径，确保高性能和数据一致性。
- 探索更多可插拔层的功能，以支持新的特性和优化。

#### 后续行动计划
- 继续进行代码走读和优化工作，特别是在实时迁移和加密层方面。
- 社区成员可以通过邮件列表和IRC进行交流和反馈。

#### 会议结束
感谢Jason的详细讲解，会议内容将被记录并上传至Ceph YouTube频道。期待下次的代码走读会议。

---

以上是本次会议的详细纪要，涵盖了会议的关键细节、讨论的主要议题、决定的事项以及后续的行动计划。