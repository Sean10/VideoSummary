---
title: "Bug of the Year: A Memory Leak Reboot Could Not Help with - Radoslaw Zarzynski, IBM"
date: 2023-05-05
updated: 2023-05-05
tags:
categories:
- "视频总结"
subtitle: tech
---


### 会议纪要

#### 会议参与者
- Radek

#### 会议时间
- 2023年某月某日

#### 会议主题
- 讨论并解决Ceph存储系统中的一个长期存在的内存泄漏（memory leak）问题

#### 会议内容总结

1. **问题背景与引入**
   - Radek自2015年起从嵌入式设备领域转入Ceph存储系统的开发。
   - 讨论了一个特殊的内存泄漏问题，该问题对重启等常规处理手段具有免疫力。

2. **问题描述**
   - 该内存泄漏问题存在于OSD（Object Storage Daemon）启动时从磁盘加载的内存结构中。
   - 问题自2017年起存在于代码中，并在Octopus版本中因自动缩放器（auto scalar）的默认设置更改而加剧。

3. **技术细节**
   - 问题根源在于C++标准库（STDC++）中的`std::list`容器的`size`方法在某些版本中不是常数时间复杂度。
   - 该问题导致PG锁（PG lock）中的dupes结构在处理重复操作时出现问题。

4. **问题影响与症状**
   - 内存泄漏导致OSD在处理恢复和 peering 过程时消耗更多内存和CPU资源。
   - 症状包括增加的延迟、内存使用量上升、TC malloc警告、以及OSD间歇性闪烁。

5. **诊断方法**
   - 传统方法包括停止OSD并使用`objectstore_tool`工具导出PG锁，但这具有侵入性。
   - 非侵入性方法包括使用admin socket命令观察mempools统计信息。

6. **解决方案与修复**
   - 修复工作分为多个阶段，首先解决离线工具（CLT）对dupes结构的无知问题。
   - 在线修复涉及在OSD启动时逐步清理膨胀的dupes条目，避免一次性大量删除导致的问题。

7. **后续行动计划**
   - 继续监控和优化修复措施，确保集群稳定运行。
   - 开发和部署更多的诊断工具，以便未来能更有效地发现和处理类似问题。

#### 结论
- 该内存泄漏问题虽然复杂且难以诊断，但通过团队的共同努力，已经找到了有效的修复方法。未来将加强代码审查和测试，以防止类似问题再次发生。

#### 行动项
- 继续监控修复后的集群性能。
- 开发和部署新的诊断工具。
- 加强代码审查和测试流程。

---

以上是本次会议的详细纪要，涵盖了会议的关键细节、讨论的主要议题、决定的事项以及后续的行动计划。