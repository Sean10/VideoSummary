---
title: "Ceph Code Walkthroughs: Crimson"
date: 2024-03-06
updated: 2024-03-07
tags:
categories:
- "视频总结"
subtitle: tech
---


### 会议纪要

#### 关键细节
- **主题**: 讨论 Crimson 代码与经典代码的差异，特别是使用 seastar 框架的情况。
- **参与者**: 分布式存储 Ceph 研发人员。
- **时间**: 会议具体时间未提供。
- **地点**: 线上视频会议。

#### 讨论的主要议题
1. **经典代码与 Crimson 代码的比较**：
   - 经典代码是同步的，处理请求简单直接。
   - Crimson 代码使用 seastar 框架，主要使用 Futures 和 Continuation。
   - Continuation 是 C++ Lambda 表达式，用于在 Future 就绪或被赋值时调用。

2. **Lambda 表达式中的指针对象捕获**：
   - 讨论了在 Lambda 表达式中捕获 `this` 指针的安全性，建议避免捕获 `con` 和 `request` 以防止生命周期问题。

3. **消息处理机制**：
   - 介绍了 messenger 组件，它是 Ceph 中的通信层，处理不同类型的消息如 mosd_op。
   - mosd_op 代表 OSD 操作，是实际的 RADOS 操作，包含对象 ID 和一系列操作（如删除、写入等）。

4. **对象上下文 (Object Context)**：
   - 对象上下文是一个缓存数据结构，用于跟踪对象的修改状态。
   - 讨论了获取对象上下文的逻辑，包括从缓存中获取或从后端加载。

5. **Crimson 代码的目录结构**：
   - Crimson 代码主要位于 Crimson 目录中，是经典 OSD 的替代品。
   - 讨论了在 Crimson 代码中使用的一些特殊宏和适配问题。

6. **客户端请求管道 (Client Request Pipeline)**：
   - 介绍了 Crimson 中的客户端请求管道，包括等待地图阶段、活动等待阶段等。
   - 强调了在处理请求时需要满足的依赖条件，如 OSD 地图版本匹配。

7. **错误处理**：
   - 讨论了使用 erator 处理非严重错误的情况，确保程序在遇到错误时不会崩溃，而是继续运行并知道如何处理这些错误。

#### 决定的事项
- 确认了在 Crimson 代码中使用 seastar 框架的必要性和优势。
- 确定了在处理请求时需要满足的依赖条件，并讨论了如何处理这些条件不满足的情况。
- 讨论了错误处理的策略，特别是使用 erator 来处理非严重错误。

#### 后续的行动计划
- 继续优化 Crimson 代码，特别是在错误处理和依赖条件满足方面的逻辑。
- 深入研究 seastar 框架的使用，确保代码的高效和稳定。
- 定期审查和更新代码，以保持其与 Ceph 其他部分的兼容性和一致性。

#### 备注
- 会议中提到了一些技术细节和代码示例，这些内容对于深入理解 Crimson 代码的实现非常重要。
- 会议强调了代码的可维护性和错误处理的策略，这些都是确保系统稳定运行的关键因素。

---

以上是根据会议内容总结的会议纪要，涵盖了会议的关键细节、讨论的主要议题、决定的事项以及后续的行动计划。